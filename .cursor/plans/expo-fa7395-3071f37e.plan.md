<!-- 3071f37e-85a5-4b25-a424-fe513edf4b3c ca60c5d9-eb6e-4e94-8901-cc3799851eec -->
# Expo iOS Do/Done Board (Supabase-backed)

## Scope

- iOS-only Expo app, single "primary" board.
- Two columns: `do` and `done`.
- Interactions: quick add, tap-to-edit, swipe right to toggle (do⇄done), long-press reorder (persisted with `position`).
- Uses existing Supabase backend and RLS. No realtime, no offline for MVP.

## Architecture (simple, boring)

- Expo managed app (no router lib). Single stack: Auth → Board.
- Minimal deps: `@supabase/supabase-js`, `@react-native-async-storage/async-storage`, `react-native-gesture-handler`, `react-native-reanimated`, `react-native-draggable-flatlist`.
- Env config via `app.config.ts` → `Constants.expoConfig.extra` for `SUPABASE_URL` and `SUPABASE_ANON_KEY`.

## Data Model & Queries

- Pick the first user-owned board (or optional hardcoded `BOARD_SLUG`).
- Resolve `board_columns.slug in ('do','done')` for column ids.
- Load todos filtered by `(owner_id, board_id, column_id)` ordered by `position desc, created_at desc`.
- Persist reorder by writing a single row’s `position`:
  - New top: `max(position)+1000`.
  - Between neighbors: average of adjacent positions.
  - If positions get too tight, renormalize the visible list to 1000-steps (rare; add only if needed).

## Screens

- AuthScreen: email/password sign-in with Supabase (session stored in AsyncStorage).
- BoardScreen: segmented control (Do | Done), top quick-add input, list of items with:
  - Tap → inline TextInput; save on blur/submit.
  - Swipe right → toggle column (move to top of target column).
  - Long-press drag → reorder within current column.

## Gestures & UX

- List: `DraggableFlatList` for long-press reordering.
- Row: wrap in `Swipeable` (gesture-handler) for right swipe to toggle.
- Prevent conflicts by ignoring drag while swipe is active and vice-versa.
- Keyboard: return-to-add, return-to-save, auto-focus when entering edit/add.

## Supabase Client (React Native)

- Use `createClient(url, key, { auth: { storage: AsyncStorage } })`.
- Simple wrapper functions:
  - `getPrimaryBoard()`
  - `getDoDoneColumns(boardId)`
  - `listTodos(boardId, columnId)`
  - `insertTodo(boardId, columnId, text, position?)`
  - `updateTodoText(id, text)`
  - `moveTodoToColumn(id, targetColumnId, position)`
  - `updateTodoPosition(id, position)`

## Position logic (essential snippet)

```ts
function computeNewPosition(index: number, items: { position: number }[]): number {
  if (index === 0) {
    const top = items.length ? items[0].position : 0;
    return top + 1000; // new top
  }
  if (index >= items.length) {
    const bottom = items[items.length - 1]?.position ?? 0;
    return Math.max(bottom - 1000, 0); // new bottom
  }
  const prev = items[index - 1].position;
  const next = items[index].position;
  return Math.floor((prev + next) / 2); // between neighbors
}
```

## iOS polish (MVP-only)

- Use SafeAreaView; large hit targets; 16pt spacing; system fonts.
- Haptics on add, toggle, and reorder (optional with `expo-haptics`).
- Dark mode support via system color scheme (no theme system yet).

## Out of scope (deferred)

- Realtime sync, offline cache, push notifications, theming system, multi-board UI.

## Setup Notes

- Provide `app.config.ts` with `extra: { SUPABASE_URL, SUPABASE_ANON_KEY, BOARD_SLUG? }`.
- If `BOARD_SLUG` missing, we pick the first board; if `do/done` columns absent, show a blocking error with a “Fix” button that creates them (1 insert into `board_columns` each).

## Test Flow (manual)

- Sign in; Board loads Do by default.
- Quick add: item appears at top.
- Swipe right: item moves to Done (top), switching to Done shows it first.
- Long-press drag: reorder persists across reloads.
- Tap to edit: text updates and persists.

### To-dos

- [ ] Initialize Expo app and add minimal dependencies
- [ ] Configure Supabase client with AsyncStorage and env extras
- [ ] Implement email/password AuthScreen with session persistence
- [ ] Add simple API wrappers for board, columns, todos
- [ ] Build BoardScreen with segmented (Do/Done) and quick-add input
- [ ] Implement swipe-to-toggle and long-press reorder with persisted position
- [ ] Enable tap-to-edit with inline TextInput save
- [ ] Add SafeArea, keyboard handling, minor haptics
- [ ] Manual QA of add/toggle/reorder/edit and refresh persistence